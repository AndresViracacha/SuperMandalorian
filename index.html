<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <script src=" https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.16.1/phaser.min.js"></script>
  <script src="./scripts/caminado.js"></script>
  <script src="./scripts/acciones.js"></script>
  <script src="./scripts/setup.js"></script>
  <script src="./scripts/controls.js"></script>
  <script>
    var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.CANVAS, 'phaser-example', { preload: preload, create: create, update: update });
    function preload() {
      game.load.spritesheet('dude', './assets/Mandalorian.png', 64, 64);
      game.load.image('plataforma', './assets/plataforma.png');
      game.load.image('background', './assets/fondo.png');
      game.load.image('bullet', './assets/bala.png');
    }
    var controles, player, player2, hpPlayer = 100, hpPlayer2 = 100, tiempo = 60, tiempoTexto, text, facing, facing2, cursors, cursors2, plataformas, rollRight, rollLeft, rollRight2, rollLeft2, jumpTimer, background, lastTime, clickDelay, lastTime2, clickDelay2, bullets, bullets2, bulletTime = 0, bulletTime2 = 0, fireButton, fireButton2;
    function create() {
      game.physics.startSystem(Phaser.Physics.ARCADE);
      background = game.add.sprite(0, 0, "background");
      //game.physics.arcade.gravity.y = 250;
      //Balas
      bullets = crearBalas(bullets, game, Phaser)
      bullets2 = crearBalas(bullets2, game, Phaser)
      tiempoTexto = game.add.text(game.world.centerX, 100, tiempo, {
        font: "65px Arial",
        fill: "#ffff00",
        align: "center",
      });
      tiempoTexto.anchor.set(0.5);

      let { cursors, cursors2, fireButton, fireButton2 } = controles(game, Phaser)
      plataformas = crearPlataformas(plataformas, game);
      player = crearPersonaje(player, game, Phaser)
      player2 = crearPersonaje(player2, game, Phaser)
    }

    function update() {

      //Colision jugador1
      if (cursors.down.justDown) {
        clickDelay = this.time.now - lastTime;
        lastTime = this.time.now;
      }
      if (clickDelay < 350) {
        console.log("sx");
        setTimeout(() => {
          clickDelay = 1000;
        }, 250);
      } else {
        if (
          (player.position.y < 240 &&
            player.position.x > 0 &&
            player.position.x < 255) ||
          (player.position.y < 490 &&
            player.position.x > 500 &&
            player.position.x < 755)
        ) {
          game.physics.arcade.collide(player, plataformas);
        }
      }
      //Colision jugador2
      if (cursors2.down.justDown) {
        clickDelay2 = this.time.now - lastTime2;
        lastTime2 = this.time.now;
      }
      if (clickDelay2 < 350) {
        console.log("sx");
        setTimeout(() => {
          clickDelay2 = 1000;
        }, 250);
      } else {
        if (
          (player2.position.y < 240 &&
            player2.position.x > 0 &&
            player2.position.x < 255) ||
          (player2.position.y < 490 &&
            player2.position.x > 500 &&
            player2.position.x < 755)
        ) {
          game.physics.arcade.collide(player2, plataformas);
        }
      }

      //Contador
      tiempo = tiempo - 0.02;
      tiempoTexto.text = Math.floor(tiempo);

      //jugador 1
      player.body.velocity.x = 0
      facing = caminar(cursors, player, facing, rollRight, rollLeft);
      rollRight = rodarDerecha(cursors, player, rollRight);
      rollLeft = rodarIzquierda(cursors, player, rollLeft);

      //jugador 2
      player2.body.velocity.x = 0
      facing2 = caminar(cursors2, player2, facing2, rollRight2, rollLeft2);
      rollRight2 = rodarDerecha(cursors2, player2, rollRight2);
      rollLeft2 = rodarIzquierda(cursors2, player2, rollLeft2);

      //disparo
      if (fireButton.isDown && player.alive) {
        bulletTime = fireBullet(facing, bullets, player, bulletTime);
      }
      if (fireButton2.isDown && player2.alive) {
        bulletTime2 = fireBullet(facing2, bullets2, player2, bulletTime2);
      }

      game.physics.arcade.overlap(player2, bullets, disparo, null, this)
      game.physics.arcade.overlap(player, bullets2, disparo, null, this)

      //collide da touch y keep y on floor, blocked
      saltar(player, cursors);
      saltar(player2, cursors2);
      //terminar juego
      if (tiempo <= 0) {
        //console.log("termino")
      }
    }
  </script>
</body>

</html>